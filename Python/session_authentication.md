## Authentication

Authentication is the process of verifying the identity of a user, device, or entity in a system. It's like showing your ID card to prove who you are before being allowed to enter a building. In the digital world, authentication ensures that the person or system accessing your data or services is who they claim to be.

### Key Concepts of Authentication

1. **User Credentials:** These are the details users provide to prove their identity, commonly a username and password.
2. **Multi-Factor Authentication (MFA):** This involves two or more verification methods, such as something you know (password), something you have (phone), and something you are (fingerprint).
3. **Tokens:** These are digital keys or codes that users or systems use to prove their identity without needing to re-enter their credentials.
4. **Biometrics:** These are physical characteristics, such as fingerprints or facial recognition, used to identify and authenticate individuals.

### Types of Authentication

1. **Password-Based Authentication:** The most common method where users provide a username and password.
2. **Token-Based Authentication:** Uses a token, often generated by a server, to authenticate users. Examples include API tokens and session tokens.
3. **Biometric Authentication:** Uses unique physical characteristics like fingerprints, facial recognition, or iris scans.
4. **Certificate-Based Authentication:** Uses digital certificates issued by a trusted entity to verify identity.
5. **Two-Factor Authentication (2FA):** Combines two different authentication methods to enhance security. For example, a password plus a one-time code sent to your phone.

### How Authentication Works

1. **User Input:** The user provides their credentials (e.g., username and password).
2. **Validation:** The system checks these credentials against its stored records.
3. **Grant Access:** If the credentials match, the user is granted access to the system. If not, access is denied.

### Example Code Snippets

#### Password-Based Authentication (Python Flask)

```python
from flask import Flask, request, jsonify

app = Flask(__name__)

# Sample data for user credentials
users = {
    "john_doe": "password123",
    "jane_smith": "securepassword"
}

@app.route('/login', methods=['POST'])
def login():
    data = request.json
    username = data.get('username')
    password = data.get('password')
    
    if username in users and users[username] == password:
        return jsonify({"message": "Login successful"}), 200
    else:
        return jsonify({"message": "Invalid credentials"}), 401

if __name__ == '__main__':
    app.run(debug=True)
```

#### Token-Based Authentication (Python Flask with JWT)

```python
from flask import Flask, request, jsonify
import jwt
import datetime

app = Flask(__name__)
app.config['SECRET_KEY'] = 'your_secret_key'

users = {
    "john_doe": "password123",
    "jane_smith": "securepassword"
}

def generate_token(username):
    token = jwt.encode(
        {"username": username, "exp": datetime.datetime.utcnow() + datetime.timedelta(hours=1)},
        app.config['SECRET_KEY'],
        algorithm="HS256"
    )
    return token

@app.route('/login', methods=['POST'])
def login():
    data = request.json
    username = data.get('username')
    password = data.get('password')
    
    if username in users and users[username] == password:
        token = generate_token(username)
        return jsonify({"token": token}), 200
    else:
        return jsonify({"message": "Invalid credentials"}), 401

@app.route('/protected', methods=['GET'])
def protected():
    token = request.headers.get('Authorization')
    
    if not token:
        return jsonify({"message": "Token is missing!"}), 403
    
    try:
        data = jwt.decode(token, app.config['SECRET_KEY'], algorithms=["HS256"])
        return jsonify({"message": f"Welcome {data['username']}!"}), 200
    except jwt.ExpiredSignatureError:
        return jsonify({"message": "Token has expired!"}), 403
    except jwt.InvalidTokenError:
        return jsonify({"message": "Invalid token!"}), 403

if __name__ == '__main__':
    app.run(debug=True)
```

### Real-World Applications

1. **Online Banking:** Ensures only authorized users can access their accounts.
2. **E-Commerce Sites:** Protects user data and prevents unauthorized purchases.
3. **Healthcare Systems:** Secures patient records and ensures only verified medical staff have access.
4. **Corporate Networks:** Controls access to sensitive company data and systems.

### End-of-Chapter MCQs

1. What is the primary purpose of authentication?
    a) To restrict access to unauthorized users  
    b) To store user data  
    c) To manage network traffic  
    d) To encrypt data  

2. What are user credentials typically composed of?
    a) Username and password  
    b) IP address and hostname  
    c) Date of birth and address  
    d) Email and phone number  

3. Which authentication method involves using a one-time code sent to a user's phone?
    a) Password-Based Authentication  
    b) Biometric Authentication  
    c) Two-Factor Authentication  
    d) Token-Based Authentication  

4. What is the main advantage of using multi-factor authentication (MFA)?
    a) Faster login process  
    b) Enhanced security  
    c) Simplified user management  
    d) Reduced storage space  

5. In token-based authentication, what is a token?
    a) A physical key  
    b) A digital certificate  
    c) A temporary digital key  
    d) A biometric scan  

6. Which of the following is an example of biometric authentication?
    a) Password  
    b) Security question  
    c) Fingerprint scan  
    d) PIN code  

7. What happens if the credentials provided during authentication do not match the stored records?
    a) Access is granted  
    b) Access is denied  
    c) System crashes  
    d) User is redirected to the home page  

8. In the provided Flask example, what is the role of the `generate_token` function?
    a) To create a new user account  
    b) To generate a JWT token for authentication  
    c) To reset the user's password  
    d) To verify the user's credentials  

9. What does JWT stand for in the context of token-based authentication?
    a) Java Web Token  
    b) JSON Web Token  
    c) Jumbled Web Token  
    d) JavaScript Web Token  

10. Which of the following is NOT a type of authentication?
    a) Password-Based Authentication  
    b) Token-Based Authentication  
    c) Biometric Authentication  
    d) Hardware-Based Authentication  

### Answers

1. a) To restrict access to unauthorized users
2. a) Username and password
3. c) Two-Factor Authentication
4. b) Enhanced security
5. c) A temporary digital key
6. c) Fingerprint scan
7. b) Access is denied
8. b) To generate a JWT token for authentication
9. b) JSON Web Token
10. d) Hardware-Based Authentication

## Session Authentication

Session authentication is a process used in web applications to keep track of users once they have logged in. It ensures that users don't have to re-enter their credentials every time they navigate to a new page within the application. This is achieved by maintaining a "session" that remembers the user's state and permissions.

### Key Concepts of Session Authentication

1. **Session ID:** A unique identifier assigned to a user once they log in. This ID is stored on the server and sent to the user's browser as a cookie.
2. **Cookies:** Small pieces of data stored on the user's browser. Cookies are used to store the session ID.
3. **Server-Side Storage:** The server maintains a record of all active sessions and their associated user information.
4. **Session Expiry:** Sessions can expire after a certain period of inactivity or when the user logs out, ensuring security.

### How Session Authentication Works

1. **User Logs In:** The user provides their credentials (username and password) on the login page.
2. **Server Validates Credentials:** The server checks the provided credentials against its stored records.
3. **Create Session:** If the credentials are correct, the server creates a session for the user and generates a unique session ID.
4. **Send Session ID:** The session ID is sent to the user's browser and stored as a cookie.
5. **Maintain Session:** For each subsequent request from the user's browser, the session ID is sent to the server via the cookie.
6. **Verify Session ID:** The server checks the session ID against its records to verify the user's identity and maintain their logged-in state.

### Example Code Snippets

#### Basic Session Authentication (Python Flask)

```python
from flask import Flask, request, jsonify, session

app = Flask(__name__)
app.secret_key = 'super_secret_key'  # Used to encrypt session data

# Sample data for user credentials
users = {
    "john_doe": "password123",
    "jane_smith": "securepassword"
}

@app.route('/login', methods=['POST'])
def login():
    data = request.json
    username = data.get('username')
    password = data.get('password')
    
    if username in users and users[username] == password:
        session['username'] = username  # Store the username in session
        return jsonify({"message": "Login successful"}), 200
    else:
        return jsonify({"message": "Invalid credentials"}), 401

@app.route('/dashboard', methods=['GET'])
def dashboard():
    if 'username' in session:
        return jsonify({"message": f"Welcome {session['username']}!"}), 200
    else:
        return jsonify({"message": "Unauthorized access"}), 401

@app.route('/logout', methods=['POST'])
def logout():
    session.pop('username', None)  # Remove the username from session
    return jsonify({"message": "Logged out successfully"}), 200

if __name__ == '__main__':
    app.run(debug=True)
```

### Real-World Applications

1. **Social Media Platforms:** Keeping users logged in as they navigate through different sections.
2. **E-Commerce Websites:** Ensuring that users remain authenticated while browsing products, adding items to their cart, and checking out.
3. **Online Banking:** Maintaining user sessions for secure and continuous access to banking features.

### End-of-Chapter MCQs

1. What is a session ID?
    a) A username  
    b) A unique identifier for a user session  
    c) A password  
    d) A cookie policy  

2. Where is the session ID typically stored on the client side?
    a) In the server database  
    b) In a cookie  
    c) In local storage  
    d) In the browser's cache  

3. What is the purpose of a session in web applications?
    a) To speed up the server  
    b) To keep track of users' activities and maintain their logged-in state  
    c) To store large files  
    d) To manage databases  

4. What does the server do when a user logs out?
    a) Creates a new session  
    b) Deletes the user's account  
    c) Removes the session data  
    d) Sends an email notification  

5. How does the server identify the user in subsequent requests after login?
    a) By asking for the password again  
    b) By using the session ID stored in the cookie  
    c) By checking the IP address  
    d) By verifying the email address  

6. What is the role of the `secret_key` in Flask session management?
    a) To encrypt session data  
    b) To store passwords  
    c) To generate session IDs  
    d) To manage server logs  

7. What happens if the session ID in the cookie does not match any session on the server?
    a) The user is granted access  
    b) The user is asked to log in again  
    c) The server crashes  
    d) The session is recreated  

8. What is one way to enhance the security of session authentication?
    a) Storing session IDs in plaintext  
    b) Using secure cookies  
    c) Allowing unlimited session duration  
    d) Disabling session expiry  

9. In the provided Flask example, what does `session.pop('username', None)` do?
    a) Logs the user in  
    b) Logs the user out  
    c) Resets the password  
    d) Creates a new session  

10. Why is session expiry important?
    a) To increase server load  
    b) To maintain the integrity of user data  
    c) To prevent unauthorized access due to prolonged inactivity  
    d) To simplify user management  

### Answers

1. b) A unique identifier for a user session
2. b) In a cookie
3. b) To keep track of users' activities and maintain their logged-in state
4. c) Removes the session data
5. b) By using the session ID stored in the cookie
6. a) To encrypt session data
7. b) The user is asked to log in again
8. b) Using secure cookies
9. b) Logs the user out
10. c) To prevent unauthorized access due to prolonged inactivity

## What Cookies Are

Cookies are small pieces of data stored on the user's computer by their web browser while they are browsing a website. They are used to remember information about the user, such as login status, preferences, and other details, across multiple pages and visits to the site.

### Key Concepts of Cookies

1. **Storage:** Cookies are stored as text files in the user's browser.
2. **Content:** They typically contain a name, value, expiration date, and domain/path they are valid for.
3. **Purpose:** Cookies are used for session management, personalization, and tracking.

### Types of Cookies

1. **Session Cookies:** Temporary cookies that are deleted when the user closes the browser. They are used to maintain the session state.
2. **Persistent Cookies:** These cookies remain on the user's computer for a set period or until they are manually deleted. They are used to remember user preferences and login information.
3. **First-Party Cookies:** Set by the website the user is visiting directly.
4. **Third-Party Cookies:** Set by domains other than the one the user is visiting, often used for tracking and advertising purposes.

### How Cookies Work

1. **Setting Cookies:** When a user visits a website, the server can send a cookie to the user's browser.
2. **Storing Cookies:** The browser stores this cookie on the user's device.
3. **Sending Cookies:** On subsequent requests to the same website, the browser sends the stored cookie back to the server.

### Example Code Snippets

#### Setting and Getting Cookies (JavaScript)

```javascript
// Setting a cookie
document.cookie = "username=JohnDoe; expires=Fri, 31 Dec 2024 23:59:59 GMT; path=/";

// Getting a cookie
function getCookie(name) {
    let cookieArr = document.cookie.split(";");

    for (let i = 0; i < cookieArr.length; i++) {
        let cookiePair = cookieArr[i].split("=");
        if (name == cookiePair[0].trim()) {
            return decodeURIComponent(cookiePair[1]);
        }
    }
    return null;
}

let username = getCookie("username");
if (username) {
    console.log("Welcome back, " + username);
}
```

#### Setting and Getting Cookies (Python Flask)

```python
from flask import Flask, request, make_response

app = Flask(__name__)

@app.route('/set_cookie')
def set_cookie():
    resp = make_response("Cookie is set")
    resp.set_cookie('username', 'JohnDoe', max_age=60*60*24*365*2)  # Expires in 2 years
    return resp

@app.route('/get_cookie')
def get_cookie():
    username = request.cookies.get('username')
    if username:
        return f"Welcome back, {username}"
    else:
        return "Hello, new user!"

if __name__ == '__main__':
    app.run(debug=True)
```

### Real-World Applications

1. **Session Management:** Keeping users logged in as they navigate through a site.
2. **Personalization:** Remembering user preferences and settings.
3. **Tracking:** Monitoring user behavior for analytics and targeted advertising.

### End-of-Chapter MCQs

1. What is a cookie?
    a) A small piece of data stored on the server  
    b) A small piece of data stored on the user's computer  
    c) A type of HTTP request  
    d) A programming language  

2. Where are cookies stored?
    a) On the server  
    b) On the user's computer  
    c) In the database  
    d) In the cloud  

3. What is the purpose of a session cookie?
    a) To store data permanently  
    b) To track user behavior across websites  
    c) To maintain session state temporarily  
    d) To manage database connections  

4. What happens to session cookies when the browser is closed?
    a) They are deleted  
    b) They are stored permanently  
    c) They are transferred to the server  
    d) They are encrypted  

5. What type of cookie remains on the user's computer for a set period or until manually deleted?
    a) Session cookie  
    b) Persistent cookie  
    c) Third-party cookie  
    d) First-party cookie  

6. Which type of cookie is set by a website different from the one the user is visiting?
    a) Session cookie  
    b) Persistent cookie  
    c) Third-party cookie  
    d) First-party cookie  

7. What information is typically included in a cookie?
    a) Name and value  
    b) Expiration date  
    c) Domain and path  
    d) All of the above  

8. How can you set a cookie in JavaScript?
    a) `document.cookie = "name=value; expires=date; path=/"`  
    b) `setCookie("name", "value")`  
    c) `createCookie("name", "value")`  
    d) `cookie.set("name", "value")`  

9. In Flask, how do you get a cookie from a request?
    a) `request.get_cookie('name')`  
    b) `request.cookies.get('name')`  
    c) `request.get('name')`  
    d) `request.cookie('name')`  

10. What is one common use of cookies in web applications?
    a) To store large files  
    b) To manage user sessions  
    c) To compile code  
    d) To manage server logs  

### Answers

1. b) A small piece of data stored on the user's computer
2. b) On the user's computer
3. c) To maintain session state temporarily
4. a) They are deleted
5. b) Persistent cookie
6. c) Third-party cookie
7. d) All of the above
8. a) `document.cookie = "name=value; expires=date; path=/"`
9. b) `request.cookies.get('name')`
10. b) To manage user sessions

## How to Send Cookies

Sending cookies is an essential part of web development. Cookies are small pieces of data that a server sends to the user's web browser. They are used to store information about the user, such as their login status or preferences, and can be used to track the user across different pages or even different websites.

### Key Concepts of Sending Cookies

1. **Setting Cookies:** The server sends cookies to the client, which the browser then stores.
2. **HTTP Headers:** Cookies are sent using the `Set-Cookie` header in HTTP responses.
3. **Attributes:** Cookies can have various attributes such as `expires`, `path`, `domain`, `secure`, and `HttpOnly`.
4. **Security:** Cookies can be made secure by using the `secure` and `HttpOnly` attributes.

### How to Send Cookies

1. **Setting Cookies in HTTP Response:** The server includes a `Set-Cookie` header in the HTTP response to set a cookie in the client's browser.
2. **Specifying Cookie Attributes:** The `Set-Cookie` header can include attributes to control the cookie's behavior.
3. **JavaScript:** Cookies can also be set using JavaScript on the client side.

### Example Code Snippets

#### Sending Cookies in HTTP Response (Python Flask)

```python
from flask import Flask, make_response

app = Flask(__name__)

@app.route('/set_cookie')
def set_cookie():
    resp = make_response("Cookie is set")
    resp.set_cookie('username', 'JohnDoe', max_age=60*60*24*365*2)  # Expires in 2 years
    return resp

if __name__ == '__main__':
    app.run(debug=True)
```

#### Sending Cookies with Attributes (Python Flask)

```python
@app.route('/set_secure_cookie')
def set_secure_cookie():
    resp = make_response("Secure cookie is set")
    resp.set_cookie(
        'secure_username',
        'SecureJohnDoe',
        max_age=60*60*24*365*2,  # Expires in 2 years
        secure=True,  # Only send cookie over HTTPS
        httponly=True,  # Prevent JavaScript access to the cookie
        samesite='Strict'  # Prevents the cookie from being sent with cross-site requests
    )
    return resp
```

#### Sending Cookies in JavaScript

```javascript
// Setting a cookie
document.cookie = "username=JohnDoe; expires=Fri, 31 Dec 2024 23:59:59 GMT; path=/";

// Setting a secure cookie
document.cookie = "secure_username=SecureJohnDoe; expires=Fri, 31 Dec 2024 23:59:59 GMT; path=/; Secure; HttpOnly";
```

### Real-World Applications

1. **Session Management:** Keeping users logged in as they navigate through a site.
2. **User Preferences:** Remembering user settings and preferences across different sessions.
3. **Tracking and Analytics:** Monitoring user behavior to improve website performance and user experience.

### End-of-Chapter MCQs

1. How are cookies sent from the server to the client?
    a) Using the `Content-Type` header  
    b) Using the `Set-Cookie` header  
    c) Using the `Authorization` header  
    d) Using the `Accept` header  

2. What attribute is used to make a cookie accessible only over HTTPS?
    a) `HttpOnly`  
    b) `Secure`  
    c) `Path`  
    d) `Expires`  

3. What does the `HttpOnly` attribute do?
    a) Prevents the cookie from being accessed by JavaScript  
    b) Ensures the cookie is only sent over HTTP  
    c) Sets the cookie to expire after a certain time  
    d) Restricts the cookie to a specific path  

4. How do you set a cookie in JavaScript?
    a) `document.cookie = "name=value";`  
    b) `setCookie("name", "value");`  
    c) `cookie.set("name", "value");`  
    d) `createCookie("name", "value");`  

5. What is the purpose of the `expires` attribute in a cookie?
    a) To set the cookie value  
    b) To define the expiration date of the cookie  
    c) To specify the domain for the cookie  
    d) To prevent the cookie from being accessed by JavaScript  

6. What does the `max_age` attribute do when setting a cookie in Flask?
    a) Sets the maximum size of the cookie  
    b) Defines the time in seconds until the cookie expires  
    c) Specifies the path for the cookie  
    d) Sets the cookie value  

7. Which attribute prevents a cookie from being sent with cross-site requests?
    a) `HttpOnly`  
    b) `Secure`  
    c) `SameSite`  
    d) `Path`  

8. In the provided Flask example, how long will the `username` cookie last?
    a) Until the browser is closed  
    b) 1 day  
    c) 1 year  
    d) 2 years  

9. What is the primary purpose of sending cookies from the server to the client?
    a) To store large files  
    b) To keep track of user information and maintain state  
    c) To manage server logs  
    d) To encrypt user data  

10. In JavaScript, what does the `document.cookie` property do?
    a) Sets or retrieves cookies for the current document  
    b) Deletes all cookies for the current document  
    c) Encrypts cookies for the current document  
    d) Sets the expiration date for cookies  

### Answers

1. b) Using the `Set-Cookie` header
2. b) `Secure`
3. a) Prevents the cookie from being accessed by JavaScript
4. a) `document.cookie = "name=value";`
5. b) To define the expiration date of the cookie
6. b) Defines the time in seconds until the cookie expires
7. c) `SameSite`
8. d) 2 years
9. b) To keep track of user information and maintain state
10. a) Sets or retrieves cookies for the current document

## How to Parse Cookies

Parsing cookies involves reading and extracting information from cookies stored in the browser. This is a crucial part of web development, allowing servers and client-side scripts to access and utilize stored data such as user preferences, session information, and other relevant details.

### Key Concepts of Parsing Cookies

1. **Cookie Structure:** Cookies typically contain key-value pairs separated by `=` and are often joined together by `;`.
2. **Reading Cookies:** Accessing cookies from the browser involves retrieving the `document.cookie` property.
3. **Extracting Values:** Once the cookie string is retrieved, it needs to be split and parsed to extract the desired key-value pairs.

### How to Parse Cookies

1. **Retrieve Cookies:** Access the cookie string using `document.cookie` in JavaScript or via the `Cookie` header in server-side languages.
2. **Split Cookies:** Split the cookie string into individual cookies based on the `;` separator.
3. **Extract Key-Value Pairs:** Split each individual cookie by `=` to get the key and value.

### Example Code Snippets

#### Parsing Cookies in JavaScript

```javascript
// Function to parse cookies and return an object of key-value pairs
function parseCookies() {
    let cookies = document.cookie.split(';');
    let cookieObj = {};
    cookies.forEach(cookie => {
        let [name, value] = cookie.split('=');
        cookieObj[name.trim()] = value;
    });
    return cookieObj;
}

// Usage
let cookies = parseCookies();
console.log(cookies);  // Outputs an object with all the cookies as key-value pairs
```

#### Parsing Cookies in Python Flask

```python
from flask import Flask, request

app = Flask(__name__)

@app.route('/get_cookies')
def get_cookies():
    cookies = request.cookies
    cookie_dict = {}
    for key, value in cookies.items():
        cookie_dict[key] = value
    return cookie_dict

if __name__ == '__main__':
    app.run(debug=True)
```

### Real-World Applications

1. **User Authentication:** Parsing cookies to verify user sessions.
2. **Personalization:** Reading user preferences stored in cookies to customize the user experience.
3. **Tracking and Analytics:** Extracting tracking information from cookies for analytics purposes.

### End-of-Chapter MCQs

1. What method is used in JavaScript to access cookies?
    a) `window.cookie`  
    b) `document.cookie`  
    c) `navigator.cookie`  
    d) `location.cookie`  

2. How are individual cookies separated in the `document.cookie` string?
    a) By commas (`,`)  
    b) By spaces (` `)  
    c) By semicolons (`;`)  
    d) By colons (`:`)  

3. Which method is used to split a string in JavaScript?
    a) `slice()`  
    b) `split()`  
    c) `splice()`  
    d) `separate()`  

4. In the JavaScript function `parseCookies()`, what does `cookie.split('=')` do?
    a) Combines cookies into a single string  
    b) Separates the cookie name from the cookie value  
    c) Deletes the cookie  
    d) Encrypts the cookie  

5. How do you access cookies in a Flask route?
    a) `request.get('Cookie')`  
    b) `request.headers['Cookie']`  
    c) `request.cookies`  
    d) `request.get_cookies()`  

6. What does the `trim()` function do in JavaScript?
    a) Splits a string into an array  
    b) Removes whitespace from both ends of a string  
    c) Converts a string to lowercase  
    d) Joins two strings together  

7. Which HTTP header is used to send cookies from the client to the server?
    a) `Set-Cookie`  
    b) `Authorization`  
    c) `Cookie`  
    d) `Accept`  

8. In Python Flask, how do you iterate over cookies?
    a) `for key, value in request.cookies.items()`  
    b) `for cookie in request.cookies.get()`  
    c) `for cookie in request.get_cookies()`  
    d) `for key, value in request.headers.items()`  

9. What is the purpose of parsing cookies in web development?
    a) To encrypt user data  
    b) To read and utilize stored information  
    c) To delete cookies  
    d) To increase website load speed  

10. In the provided JavaScript example, what data structure is used to store parsed cookies?
    a) Array  
    b) Set  
    c) Object  
    d) Map  

### Answers

1. b) `document.cookie`
2. c) By semicolons (`;`)
3. b) `split()`
4. b) Separates the cookie name from the cookie value
5. c) `request.cookies`
6. b) Removes whitespace from both ends of a string
7. c) `Cookie`
8. a) `for key, value in request.cookies.items()`
9. b) To read and utilize stored information
10. c) Object

## 0. Et moi et moi et moi!

### Implementing Basic Authentication for User Endpoints

In this section, we focus on extending basic authentication to handle a new endpoint that retrieves the authenticated User object. We will follow these steps:

1. **Copy Previous Work:**
   - Ensure that the folders `models` and `api` from the previous project `0x06. Basic authentication` are copied into the new folder.
   - Confirm all mandatory tasks of the previous project are completed at 100% since this project builds on it.

2. **Update `@app.before_request`:**
   - In `api/v1/app.py`, modify the `@app.before_request` to assign the result of `auth.current_user(request)` to `request.current_user`.

3. **Update Route for `GET /api/v1/users/<user_id>`:**
   - In `api/v1/views/users.py`, update the method for the route `GET /api/v1/users/<user_id>`.
   - If `<user_id>` is equal to `me` and `request.current_user` is `None`, abort with a 404 error.
   - If `<user_id>` is equal to `me` and `request.current_user` is not `None`, return the authenticated User in a JSON response.
   - Otherwise, maintain the current behavior for `GET /api/v1/users/<user_id>`.

### Example Code Snippet

#### Updating `app.py`

```python
@app.before_request
def before_request():
    if auth is None:
        return
    request.current_user = auth.current_user(request)
```

#### Updating `users.py`

```python
@app.route('/api/v1/users/<user_id>', methods=['GET'])
def get_user(user_id):
    if user_id == "me":
        if request.current_user is None:
            abort(404)
        return jsonify(request.current_user.to_json())
    user = User.get(user_id)
    if user is None:
        abort(404)
    return jsonify(user.to_json())
```

## 1. Empty Session

### Creating the SessionAuth Class

1. **Create `SessionAuth` Class:**
   - Inherit from `Auth`.
   - Ensure the class is empty initially, validating inheritance and "switch" mechanism using environment variables.

2. **Update `api/v1/app.py`:**
   - Import `SessionAuth` from `api.v1.auth.session_auth`.
   - Create an instance of `SessionAuth` and assign it to the variable `auth` based on the environment variable `AUTH_TYPE`.

### Example Code Snippet

#### Creating `SessionAuth` Class

```python
class SessionAuth(Auth):
    pass
```

#### Updating `app.py`

```python
from api.v1.auth.session_auth import SessionAuth

auth = None
if os.getenv('AUTH_TYPE') == 'session_auth':
    auth = SessionAuth()
```

## 2. Create a Session

### Updating SessionAuth Class

1. **Add `user_id_by_session_id` Attribute:**
   - Initialize as an empty dictionary.

2. **Create `create_session` Method:**
   - Generate a Session ID using `uuid.uuid4()`.
   - Store the Session ID and associated user_id in `user_id_by_session_id`.
   - Return the Session ID.

### Example Code Snippet

#### Updating `SessionAuth` Class

```python
import uuid

class SessionAuth(Auth):
    user_id_by_session_id = {}

    def create_session(self, user_id=None):
        if user_id is None or not isinstance(user_id, str):
            return None
        session_id = str(uuid.uuid4())
        self.user_id_by_session_id[session_id] = user_id
        return session_id
```

## 3. User ID for Session ID

### Creating `user_id_for_session_id` Method

1. **Retrieve User ID Based on Session ID:**
   - Return the value (User ID) for the key `session_id` in the dictionary `user_id_by_session_id`.

### Example Code Snippet

#### Updating `SessionAuth` Class

```python
class SessionAuth(Auth):
    user_id_by_session_id = {}

    def create_session(self, user_id=None):
        if user_id is None or not isinstance(user_id, str):
            return None
        session_id = str(uuid.uuid4())
        self.user_id_by_session_id[session_id] = user_id
        return session_id

    def user_id_for_session_id(self, session_id=None):
        if session_id is None or not isinstance(session_id, str):
            return None
        return self.user_id_by_session_id.get(session_id)
```

## 4. Session Cookie

### Adding `session_cookie` Method

1. **Retrieve Cookie Value from Request:**
   - Return the value of the cookie named `_my_session_id` from the request.

### Example Code Snippet

#### Updating `auth.py`

```python
class Auth:
    def session_cookie(self, request=None):
        if request is None:
            return None
        return request.cookies.get(os.getenv('SESSION_NAME'))
```

## 5. Before Request

### Updating `@app.before_request`

1. **Exclude Path `/api/v1/auth_session/login/`:**
   - Ensure this route is accessible outside authentication.

2. **Check for Authorization Header and Session Cookie:**
   - Abort with a 401 error if both are `None`.

### Example Code Snippet

#### Updating `app.py`

```python
@app.before_request
def before_request():
    if auth is None:
        return
    excluded_paths = ['/api/v1/auth_session/login/']
    if request.path not in excluded_paths and not auth.require_auth(request.path, excluded_paths):
        if auth.authorization_header(request) is None and auth.session_cookie(request) is None:
            abort(401)
    request.current_user = auth.current_user(request)
```

## 6. Use Session ID for Identifying a User

### Updating SessionAuth Class

1. **Create `current_user` Method:**
   - Return a User instance based on a cookie value.

### Example Code Snippet

#### Updating `SessionAuth` Class

```python
class SessionAuth(Auth):
    user_id_by_session_id = {}

    def create_session(self, user_id=None):
        if user_id is None or not isinstance(user_id, str):
            return None
        session_id = str(uuid.uuid4())
        self.user_id_by_session_id[session_id] = user_id
        return session_id

    def user_id_for_session_id(self, session_id=None):
        if session_id is None or not isinstance(session_id, str):
            return None
        return self.user_id_by_session_id.get(session_id)

    def current_user(self, request=None):
        session_id = self.session_cookie(request)
        if session_id is None:
            return None
        user_id = self.user_id_for_session_id(session_id)
        if user_id is None:
            return None
        return User.get(user_id)
```

## 7. New View for Session Authentication

### Creating a New Flask View

1. **Handle `POST /auth_session/login`:**
   - Retrieve email and password from the request.
   - Authenticate the user and create a session.

### Example Code Snippet

#### Creating `session_auth.py`

```python
from flask import request, jsonify, abort
from api.v1.views import app_views
from models.user import User
from api.v1.app import auth

@app_views.route('/auth_session/login', methods=['POST'], strict_slashes=False)
def login():
    email = request.form.get('email')
    password = request.form.get('password')
    if not email:
        return jsonify({"error": "email missing"}), 400
    if not password:
        return jsonify({"error": "password missing"}), 400

    users = User.search({'email': email})
    if not users or not users[0].is_valid_password(password):
        return jsonify({"error": "wrong password"}), 401

    user = users[0]
    session_id = auth.create_session(user.id)
    response = jsonify(user.to_json())
    response.set_cookie(os.getenv('SESSION_NAME'), session_id)
    return response
```

## 8. Logout

### Updating SessionAuth Class

1. **Add `destroy_session` Method:**
   - Delete the user session/logout.

### Example Code Snippet

#### Updating `SessionAuth` Class

```python
class SessionAuth(Auth):
    user_id_by_session_id = {}

    def create_session(self, user_id=None):
        if user_id is None or not isinstance(user_id, str):
            return None
        session_id = str(uuid.uuid4())
        self.user_id_by_session_id[session_id] = user_id
        return session_id

    def user_id_for_session_id(self, session_id=None):
        if session_id is None or not isinstance(session_id, str):
            return None
        return self.user_id_by_session_id.get(session_id)

    def current_user(self, request=None):
        session_id = self.session_cookie(request)
        if session_id is None:
            return None
        user_id = self.user_id_for_session_id(session_id)
        if user_id is None:
            return None
        return User.get(user_id)

    def destroy_session(self, request=None):
        if request is None:
            return False
        session_id = self.session_cookie(request)
        if session_id is None or session_id not in self.user_id_by_session_id:
            return False
        del self.user_id_by_session_id[session_id]
        return True
```

#### Adding Logout Route

```python
@app_views.route('/auth_session/logout', methods=['DELETE'], strict_slashes=False)
def logout():
    if not auth.destroy_session(request):
        abort(404

)
    return jsonify({}), 200
```

With these steps, you can implement session-based authentication for your Flask API, providing a secure and scalable method for user authentication and session management.

## 9. Expiration?

### Adding Expiration to Session Authentication

To enhance our authentication system, we need to add an expiration date to the Session ID. This involves creating a new class, `SessionExpAuth`, which will handle sessions with an expiration time. Here’s how we can achieve this:

### Creating the `SessionExpAuth` Class

1. **Define the `SessionExpAuth` Class:**
   - Inherit from `SessionAuth`.
   - Overload the `__init__` method to initialize `session_duration`.
   - Overload the `create_session` method to include the session creation time.
   - Overload the `user_id_for_session_id` method to check if the session has expired.

2. **Overloading the `__init__` Method:**
   - Assign an instance attribute `session_duration`.
   - Fetch the environment variable `SESSION_DURATION` and cast it to an integer.
   - If the environment variable doesn’t exist or can’t be parsed, assign `session_duration` to 0.

3. **Overloading the `create_session` Method:**
   - Create a Session ID using `super()`.
   - Return `None` if `super()` can’t create a Session ID.
   - Use the Session ID as the key for the `user_id_by_session_id` dictionary.
   - Store a dictionary with `user_id` and `created_at` (current datetime) as the value for this key.

4. **Overloading the `user_id_for_session_id` Method:**
   - Return `None` if `session_id` is `None` or not found.
   - Check if `session_duration` is 0 or less; if so, return the `user_id`.
   - Validate the `created_at` key and check if the session has expired.
   - Return the `user_id` if the session is still valid.

### Example Code Snippet

#### Creating `session_exp_auth.py`

```python
from datetime import datetime, timedelta
import os

class SessionExpAuth(SessionAuth):
    def __init__(self):
        super().__init__()
        try:
            self.session_duration = int(os.getenv('SESSION_DURATION', 0))
        except ValueError:
            self.session_duration = 0

    def create_session(self, user_id=None):
        session_id = super().create_session(user_id)
        if session_id is None:
            return None
        session_dict = {
            "user_id": user_id,
            "created_at": datetime.now()
        }
        self.user_id_by_session_id[session_id] = session_dict
        return session_id

    def user_id_for_session_id(self, session_id=None):
        if session_id is None or session_id not in self.user_id_by_session_id:
            return None
        session_dict = self.user_id_by_session_id.get(session_id)
        if self.session_duration <= 0:
            return session_dict.get("user_id")
        if "created_at" not in session_dict:
            return None
        if datetime.now() > session_dict["created_at"] + timedelta(seconds=self.session_duration):
            return None
        return session_dict.get("user_id")
```

### Updating `api/v1/app.py`

```python
from api.v1.auth.session_exp_auth import SessionExpAuth

auth = None
if os.getenv('AUTH_TYPE') == 'session_exp_auth':
    auth = SessionExpAuth()
```

## 10. Sessions in Database

To avoid losing session data when the application stops, we will store session IDs in a database. We will create a new model `UserSession` and an authentication class `SessionDBAuth` that stores session data in a database.

### Creating the `UserSession` Model

1. **Define the `UserSession` Model:**
   - Inherit from `Base`.
   - Implement the `__init__` method to initialize `user_id` and `session_id`.

### Example Code Snippet

#### Creating `user_session.py`

```python
from models.base import Base

class UserSession(Base):
    def __init__(self, *args: list, **kwargs: dict):
        super().__init__(*args, **kwargs)
        self.user_id = kwargs.get('user_id')
        self.session_id = kwargs.get('session_id')
```

### Creating the `SessionDBAuth` Class

1. **Define the `SessionDBAuth` Class:**
   - Inherit from `SessionExpAuth`.
   - Overload the `create_session` method to create and store a new instance of `UserSession`.
   - Overload the `user_id_for_session_id` method to retrieve the User ID from `UserSession`.
   - Overload the `destroy_session` method to remove the `UserSession` based on the session ID.

### Example Code Snippet

#### Creating `session_db_auth.py`

```python
from models.user_session import UserSession

class SessionDBAuth(SessionExpAuth):
    def create_session(self, user_id=None):
        session_id = super().create_session(user_id)
        if session_id is None:
            return None
        user_session = UserSession(user_id=user_id, session_id=session_id)
        user_session.save()
        return session_id

    def user_id_for_session_id(self, session_id=None):
        if session_id is None:
            return None
        user_session = UserSession.search({'session_id': session_id})
        if not user_session:
            return None
        return user_session[0].user_id

    def destroy_session(self, request=None):
        if request is None:
            return False
        session_id = self.session_cookie(request)
        if session_id is None:
            return False
        user_sessions = UserSession.search({'session_id': session_id})
        if not user_sessions:
            return False
        user_sessions[0].remove()
        return True
```

### Updating `api/v1/app.py`

```python
from api.v1.auth.session_db_auth import SessionDBAuth

auth = None
if os.getenv('AUTH_TYPE') == 'session_db_auth':
    auth = SessionDBAuth()
```

### MCQs

1. What does the `session_duration` attribute represent in the `SessionExpAuth` class?
   - A) The maximum number of sessions allowed
   - B) The duration for which a session is valid
   - C) The time interval for session cleanup
   - D) The number of users currently authenticated

2. How does the `SessionExpAuth` class handle session expiration?
   - A) It deletes the session immediately after creation
   - B) It checks the `created_at` time and compares it with the current time plus `session_duration`
   - C) It uses a background process to clean up old sessions
   - D) It never expires sessions

3. What is the purpose of the `user_id_for_session_id` method in the `SessionExpAuth` class?
   - A) To create a new session
   - B) To validate the session ID
   - C) To retrieve the User ID associated with a session ID
   - D) To destroy a session

4. What is the key difference between `SessionAuth` and `SessionDBAuth`?
   - A) `SessionAuth` uses a file system, while `SessionDBAuth` uses in-memory storage
   - B) `SessionAuth` does not have session expiration, while `SessionDBAuth` does
   - C) `SessionAuth` stores sessions in memory, while `SessionDBAuth` stores sessions in a database
   - D) `SessionAuth` is not secure, while `SessionDBAuth` is secure

5. How does the `SessionDBAuth` class store session data?
   - A) In a global variable
   - B) In a database model called `UserSession`
   - C) In a temporary file
   - D) In an environment variable

6. What does the `destroy_session` method in `SessionDBAuth` do?
   - A) It creates a new session
   - B) It validates the user credentials
   - C) It removes the `UserSession` associated with the session ID
   - D) It retrieves the current user's session

7. Which method in `SessionExpAuth` is responsible for setting the session creation time?
   - A) `__init__`
   - B) `create_session`
   - C) `user_id_for_session_id`
   - D) `destroy_session`

8. What will happen if the `session_duration` is set to 0 in `SessionExpAuth`?
   - A) Sessions will never expire
   - B) Sessions will expire immediately
   - C) Sessions will be invalid
   - D) Sessions will last for one hour

9. In `SessionDBAuth`, how is a session validated?
   - A) By checking a global session list
   - B) By querying the `UserSession` model
   - C) By reading a file
   - D) By checking an environment variable

10. What is the purpose of the `SESSION_DURATION` environment variable?
    - A) To set the maximum number of sessions
    - B) To define the session expiration time
    - C) To set the cleanup interval for sessions
    - D) To limit the number of users

### Answers

1. B
2. B
3. C
4. C
5. B
6. C
7. B
8. A
9. B
10. B
